<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Consulta Frota ANTT (CSV → API)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; background:#f7f9fc }
    .card { border-radius:12px }
    pre { white-space: pre-wrap }
  </style>
</head>
<body>
  <div class="container">
    <div class="row mb-3">
      <div class="col-md-8">
        <h3>Consulta Frota ANTT — HTML (CSV → API)</h3>
        <p class="text-muted">Faça upload de um CSV com coluna <code>cnpj</code>. Configure seu endpoint REST (integrador) e uma chave de API opcional. O sistema tentará consultar cada CNPJ e retornar número de veículos e lista.</p>
      </div>
      <div class="col-md-4 text-end align-self-center">
        <small class="text-muted">Gerado por ChatGPT • &nbsp;Use com integrador (Infosimples, DataHub...)</small>
      </div>
    </div>

    <div class="card p-3 mb-3">
      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Endpoint REST (ex: https://api.infosimples.com/v1/antt/veiculo)</label>
          <input id="endpoint" class="form-control" placeholder="Cole a URL do integrador (sem ?cnpj=)" value="https://api.exemplo.com/antt/veiculo">
        </div>
        <div class="col-md-3">
          <label class="form-label">Parâmetro CNPJ (query ou path)</label>
          <select id="paramType" class="form-select">
            <option value="query" selected>query (?cnpj=)</option>
            <option value="path">path (/CNPJ)</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Chave API (opcional)</label>
          <input id="apiKey" class="form-control" placeholder="Authorization token (Bearer ...)" />
        </div>
      </div>

      <hr />
      <div class="row g-2 align-items-end">
        <div class="col-md-6">
          <label class="form-label">CSV de entrada</label>
          <input id="fileInput" type="file" accept=".csv" class="form-control" />
          <div class="form-text">O CSV precisa conter uma coluna chamada <code>cnpj</code> (com ou sem máscara).</div>
        </div>
        <div class="col-md-6 text-end">
          <button id="loadSample" class="btn btn-outline-secondary">Baixar CSV exemplo</button>
          <button id="startBtn" class="btn btn-primary">Consultar API</button>
        </div>
      </div>

      <div class="mt-3">
        <div class="progress" style="height:18px; display:none" id="progressWrap">
          <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%">0%</div>
        </div>
        <div class="mt-2" id="statusText"></div>
      </div>
    </div>

    <div class="card p-3 mb-3">
      <h5>Resultados</h5>
      <div id="resultsArea" style="max-height:400px; overflow:auto"></div>
      <div class="mt-3">
        <button id="downloadBtn" class="btn btn-success" disabled>Download CSV de resultados</button>
      </div>
    </div>

    <footer class="text-muted small">Notas: Este front é um cliente. Por limitações de CORS você pode precisar rodar um proxy ou hospedar numa origem autorizada pelo integrador. O integrador deve aceitar requisições do navegador ou fornecer chave com CORS habilitado.</footer>
  </div>

  <script>
    // Utilitários simples
    function sleep(ms){return new Promise(r=>setTimeout(r,ms))}
    function sanitizeCNPJ(s){ return (''+s).replace(/[^0-9]/g,''); }

    // Leitura CSV (puro, sem dependências)
    function csvToArray(str){
      const lines = str.split(/\r?\n/).filter(l=>l.trim().length>0);
      if(!lines.length) return [];
      const headers = lines[0].split(/,|;|\t/).map(h=>h.trim());
      return lines.slice(1).map(line=>{
        const cols = line.split(/,|;|\t/);
        const obj = {};
        headers.forEach((h,i)=> obj[h]= (cols[i]||'').trim());
        return obj;
      });
    }

    function arrayToCSV(arr){
      if(!arr.length) return '';
      const headers = Object.keys(arr[0]);
      const rows = arr.map(r => headers.map(h => '"'+( (r[h]===undefined)?'':(''+r[h]).replace(/"/g,'""') )+'"').join(','));
      return headers.join(',') + '\n' + rows.join('\n');
    }

    // DOM refs
    const fileInput = document.getElementById('fileInput');
    const startBtn = document.getElementById('startBtn');
    const endpointInput = document.getElementById('endpoint');
    const apiKeyInput = document.getElementById('apiKey');
    const paramType = document.getElementById('paramType');
    const progressWrap = document.getElementById('progressWrap');
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('statusText');
    const resultsArea = document.getElementById('resultsArea');
    const downloadBtn = document.getElementById('downloadBtn');
    const loadSample = document.getElementById('loadSample');

    let inputData = [];
    let resultData = [];

    loadSample.addEventListener('click', ()=>{
      const sample = 'cnpj;razao_social\n"12345678000190";"EMPRESA X LTDA"\n"98765432000101";"TRANSPORTES Y"';
      const blob = new Blob([sample],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download='sample_cnpj.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const txt = await f.text();
      inputData = csvToArray(txt);
      resultsArea.innerHTML = '<div class="alert alert-info">Arquivo carregado — '+inputData.length+' linhas (excluindo cabeçalho).</div>';
    });

    startBtn.addEventListener('click', async ()=>{
      if(!inputData.length){ alert('Faça upload de um CSV com coluna cnpj primeiro.'); return; }
      const endpoint = endpointInput.value.trim();
      if(!endpoint){ alert('Informe a URL do endpoint do integrador.'); return; }

      // Preparação
      resultData = [];
      progressWrap.style.display='block';
      progressBar.style.width='0%'; progressBar.textContent='0%';
      statusText.textContent='Iniciando...';

      // Processamento em lote com limite de concorrência
      const concurrency = 6; // número de requisições simultâneas
      let index = 0;

      async function worker(){
        while(true){
          const i = index++;
          if(i >= inputData.length) break;
          const row = inputData[i];
          const rawcnpj = row.cnpj || row.CNPJ || row.cnpj_raw || Object.values(row)[0];
          const cnpj = sanitizeCNPJ(rawcnpj || '');
          statusText.textContent = `Processando ${i+1} / ${inputData.length} (CNPJ: ${cnpj})`;

          try{
            const url = (paramType.value==='query') ? endpoint + '?cnpj=' + encodeURIComponent(cnpj) : endpoint.replace(/\/$/, '') + '/' + encodeURIComponent(cnpj);
            const headers = {};
            if(apiKeyInput.value.trim()) headers['Authorization'] = apiKeyInput.value.trim();

            const resp = await fetch(url, { headers });
            if(!resp.ok){
              // tenta ler o texto para debug
              const txt = await resp.text().catch(()=>resp.statusText);
              resultData.push({ cnpj, error: 'HTTP '+resp.status+' - '+txt, veiculos_count: '', veiculos_list: '' });
            } else {
              const data = await resp.json().catch(()=>null);
              // heurística para extrair lista de veículos
              let vehicles = [];
              if(!data) vehicles = [];
              else if(Array.isArray(data)) vehicles = data;
              else if(data.data && Array.isArray(data.data.veiculos)) vehicles = data.data.veiculos;
              else if(data.veiculos && Array.isArray(data.veiculos)) vehicles = data.veiculos;
              else if(data.result && Array.isArray(data.result)) vehicles = data.result;

              const count = vehicles.length || (data.total || data.count || 0);
              const list = vehicles.map(v=> v.placa || v.plate || v.placa_veiculo || (v.placa || '') ).filter(Boolean).join('|');
              resultData.push({ ...row, cnpj, veiculos_count: count, veiculos_list: list, raw_response: JSON.stringify(data) });
            }
          } catch(err){
            resultData.push({ ...row, cnpj, error: ''+err, veiculos_count: '', veiculos_list: '' });
          }

          // update progress
          const pct = Math.round(((i+1)/inputData.length)*100);
          progressBar.style.width = pct + '%'; progressBar.textContent = pct + '%';

          // pequeno delay para evitar bursts (ajuste conforme sua cota)
          await sleep(120);
        }
      }

      // start workers
      const workers = Array.from({length: concurrency}, ()=> worker());
      await Promise.all(workers);

      // final
      statusText.textContent = 'Concluído: ' + resultData.length + ' resultados.';
      progressBar.style.width = '100%'; progressBar.textContent = '100%';

      // Mostrar resultados resumidos
      const table = document.createElement('table');
      table.className = 'table table-sm';
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr><th>CNPJ</th><th>Veículos</th><th>Lista (placas)</th><th>Erro</th></tr>';
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      resultData.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.cnpj||''}</td><td>${r.veiculos_count||''}</td><td>${(r.veiculos_list||'')}</td><td>${r.error||''}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      resultsArea.innerHTML = '';
      resultsArea.appendChild(table);

      // habilitar download
      downloadBtn.disabled = false;
      downloadBtn.onclick = ()=>{
        const csv = arrayToCSV(resultData.map(r=>({ cnpj: r.cnpj, veiculos_count: r.veiculos_count, veiculos_list: r.veiculos_list, error: r.error, raw_response: r.raw_response })));
        const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='resultados_antt.csv'; a.click(); URL.revokeObjectURL(url);
      };

    });

  </script>
</body>
</html>