<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consulta CNPJ - República Federativa do Brasil</title>

  <style>
    :root {
      --verde: #009739;
      --amarelo: #FFDF00;
      --azul: #002776;
      --cinza: #f3f4f5;
      --texto: #1c1f26;
    }

    body {
      margin:0;
      padding:20px;
      background: var(--cinza);
      font-family: "Segoe UI", Inter, Arial;
      color: var(--texto);
    }

    .card {
      max-width: 980px;
      margin: 20px auto;
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 6px 20px rgba(0,0,0,.12);
      border-top: 6px solid var(--verde);
      border-bottom: 6px solid var(--amarelo);
    }

    .header {
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:15px;
      margin-bottom:20px;
    }

    .brasao {
      width:60px;
    }

    .titulo {
      font-size: 26px;
      font-weight: 800;
      color: var(--azul);
      line-height: 1.2;
    }

    .sub {
      font-size: 14px;
      opacity: .8;
    }

    button {
      padding:10px 16px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
      transition:0.2s;
    }

    .primary { background: var(--verde); color:white; }
    .primary:hover { background:#00762c; }

    .secondary { background: var(--azul); color:white; }
    .secondary:hover { background:#001d55; }

    input[type=file], input.input {
      padding:8px;
      border:1px solid #ccd2dd;
      border-radius:6px;
    }

    .row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; align-items:center; }

    .progress {
      height: 14px;
      background:#e1e6ef;
      border-radius:8px;
      overflow:hidden;
      margin-top:10px;
    }

    .progress > span {
      display:block;
      height:100%;
      background: var(--verde);
      width:0%;
      transition: width .2s ease;
    }

    pre {
      background:#0d1826;
      color:#e6eefc;
      padding:12px;
      border-radius:6px;
      height:260px;
      overflow:auto;
      font-size:13px;
      margin-top:10px;
    }

    a.link {
      color: var(--azul);
      font-weight:600;
      text-decoration:none;
      margin-top:10px;
      display:inline-block;
    }

    a.link:hover { text-decoration:underline; }
  </style>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

</head>

<body>

<div class="card">

  <!-- Cabeçalho oficial -->
  <div class="header">
    <img class="brasao" src="https://upload.wikimedia.org/wikipedia/commons/0/05/Coat_of_arms_of_Brazil.svg">
    <div>
      <div class="titulo">República Federativa do Brasil</div>
      <div class="sub">Sistema de Consulta Pública — CNPJ / BrasilAPI</div>
    </div>
  </div>

  <h2>Processador de CNPJs com BrasilAPI</h2>
  <p>Realiza upload do arquivo CSV, consulta cada CNPJ e gera novo arquivo com todas informações disponíveis.</p>

  <!-- Upload -->
  <div class="row">
    <input id="fileInput" type="file" accept=".csv">
    <button id="btnParse" class="primary">Ler CSV</button>
    <button id="btnExportCNPJs" class="secondary">Exportar CNPJs limpos</button>
  </div>

  <!-- Config API -->
  <div class="row">
    <span>API BrasilAPI:</span>
    <input id="apiBase" class="input" style="min-width:360px"
           value="https://brasilapi.com.br/api/cnpj/v1/">

    <span>Consultas/min:</span>
    <input id="callsPerMinute" class="input" style="width:80px" value="10">
  </div>

  <!-- Execução -->
  <div class="row">
    <button id="btnStart" class="primary">Iniciar Processamento</button>
    <button id="btnAbort" class="secondary" disabled>Cancelar</button>
  </div>

  <!-- Progresso -->
  <div class="progress"><span id="progressBar"></span></div>
  <div id="status" style="margin-top:10px">Aguardando…</div>

  <!-- Log -->
  <h3>Log</h3>
  <pre id="log"></pre>

  <!-- Download -->
  <a id="downloadLink" class="link" style="display:none;">Download CSV final</a>

</div>

<script>
// ----------------------------------------------
// UTILIDADES
// ----------------------------------------------
const el = id => document.getElementById(id);
const log    = el("log");
const stat   = el("status");
const pbar   = el("progressBar");
const fileInp= el("fileInput");

let parsedRows=[];
let cleanedCnpjs=[];
let abortRequested=false;

function addLog(t){ log.textContent = new Date().toLocaleTimeString()+" - "+t+"\n"+log.textContent; }
function setStatus(t,c){ stat.textContent=t; stat.style.color=c||"#000"; }
function setProgress(p){ pbar.style.width=p+"%"; }
function cleanCnpj(v){ return (v||"").replace(/\D/g,""); }

// ----------------------------------------------
// PARSE CSV
// ----------------------------------------------
el("btnParse").onclick = () => {
  const f=fileInp.files[0];
  if(!f) return setStatus("Selecione um arquivo CSV.","red");

  Papa.parse(f,{
    header:true,
    skipEmptyLines:true,
    complete: res=>{
      parsedRows=res.data;
      cleanedCnpjs=parsedRows.map((r,i)=>({
        index:i, raw:r["CNPJ"], cnpj:cleanCnpj(r["CNPJ"])
      })).filter(x=>x.cnpj);

      setStatus(`Linhas lidas: ${parsedRows.length} | CNPJs válidos: ${cleanedCnpjs.length}`, "green");
      addLog("CSV lido com sucesso.");
    }
  });
};

// ----------------------------------------------
// EXPORTAR CNPJS
// ----------------------------------------------
el("btnExportCNPJs").onclick = () => {
  if(!cleanedCnpjs.length) return;

  const csv = Papa.unparse(cleanedCnpjs.map(x=>({CNPJ:x.cnpj})));
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);

  el("downloadLink").href=url;
  el("downloadLink").download="cnpjs_limpos.csv";
  el("downloadLink").textContent="Download cnpjs_limpos.csv";
  el("downloadLink").style.display="inline-block";
};

// ----------------------------------------------
// BUSCA COM TIMEOUT
// ----------------------------------------------
async function fetchTimeout(url,ms=15000){
  const ctrl=new AbortController();
  const t=setTimeout(()=>ctrl.abort(),ms);
  try{
    const r=await fetch(url,{signal:ctrl.signal});
    clearTimeout(t);
    return r;
  }catch(e){
    clearTimeout(t);
    throw e;
  }
}

// ----------------------------------------------
// MAPEAR CAMPOS BRASILAPI
// ----------------------------------------------
function mapBrasilApi(d){
  return {
    RAZAO_SOCIAL: d.razao_social || "",
    FANTASIA: d.nome_fantasia || "",
    CAP_SOCIAL: d.capital_social || "",
    ABERTURA: d.data_inicio_atividade || "",
    MUNICIPIO: d.municipio || "",
    UF: d.uf || "",
    CNAE: d.cnae_fiscal_descricao || "",
    EMAIL: d.email || "",
    TELEFONE: d.telefone || "",
    SOCIOS: Array.isArray(d.qsa) ? d.qsa.map(s=>s.nome_socio||s.nome||"").join(" | ") : ""
  };
}

// ----------------------------------------------
// PROCESSAMENTO
// ----------------------------------------------
el("btnStart").onclick = async ()=>{

  if(!cleanedCnpjs.length) return setStatus("Nenhum CNPJ válido.","red");

  const apiBase = el("apiBase").value.trim();
  const rate = Math.max(1, parseInt(el("callsPerMinute").value)||10);
  const interval = Math.ceil(60000 / rate);

  abortRequested=false;
  el("btnAbort").disabled=false;
  el("btnStart").disabled=true;

  const results=[];

  for(let i=0;i<cleanedCnpjs.length;i++){

    if(abortRequested) break;

    const cnpj = cleanedCnpjs[i].cnpj;
    const url = apiBase.endsWith("/") ? apiBase+cnpj : apiBase+"/"+cnpj;

    addLog("Consultando "+cnpj);

    let row = {CNPJ:cnpj};

    try{
      const r = await fetchTimeout(url,15000);

      if(r.ok){
        const j = await r.json();
        row = {...row, ...mapBrasilApi(j), STATUS_API:"OK"};
      }else{
        row.STATUS_API="HTTP_"+r.status;
      }

    }catch(e){
      row.STATUS_API="ERRO_TIMEOUT";
    }

    results.push(row);
    setProgress(((i+1)/cleanedCnpjs.length)*100);
    setStatus(`Processados ${i+1}/${cleanedCnpjs.length}`);

    await new Promise(res=>setTimeout(res,interval));
  }

  // gerar CSV
  const csv=Papa.unparse(results,{quotes:true});
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);

  el("downloadLink").href=url;
  el("downloadLink").download="resultado_cnpj_brasilapi.csv";
  el("downloadLink").style.display="inline-block";
  el("downloadLink").textContent="Download resultado_cnpj_brasilapi.csv";

  setStatus("Finalizado!", "green");
  el("btnAbort").disabled=true;
  el("btnStart").disabled=false;
};

// cancelar
el("btnAbort").onclick=()=>{
  abortRequested=true;
  el("btnAbort").disabled=true;
  setStatus("Processo cancelado.","red");
  addLog("Cancelado pelo usuário.");
};

</script>

</body>
</html>
